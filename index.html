<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Billetera Virtual</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        #billetera-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px; /* Añade margen superior */
            margin-bottom: 20px; /* Añade margen inferior */
            position: relative; /* Para posicionar el mes/año */
        }

        /* NUEVO: Estilo para la visualización del mes y año */
        #current-month-year {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            background-color: #e2e6ea;
            padding: 5px 10px;
            border-radius: 5px;
        }

        #container-saldos-principales {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas más pequeñas */
        }

        #resumen-saldos {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            gap: 10px; /* Espacio entre los bloques de saldo */
        }

        /* MODIFICADO PARA TAMAÑO Y CENTRADO UNIFORME */
        .saldo-block {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center; /* Centra el texto horizontalmente */
            flex-grow: 1;       /* Permite que el bloque crezca */
            flex-shrink: 1;     /* Permite que el bloque se encoja */
            flex-basis: 150px;  /* Tamaño base sugerido para cada bloque */
            max-width: 180px;   /* Ancho máximo para evitar que se expandan demasiado */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px; /* Asegura un espacio si envuelven a la siguiente línea */

            /* Nuevas propiedades para centrar contenido interno verticalmente y asegurar altura uniforme */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centra el contenido (p y span) verticalmente */
            align-items: center; /* Centra el contenido (p y span) horizontalmente si tuvieran ancho propio menor al bloque */
        }

        .saldo-block p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }

        .saldo-block span {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            display: block; /* Asegura que el monto esté en su propia línea */
            margin-top: 5px;
        }

        #saldos-iniciales, #forms-container, #historial-container, #transfer-container {
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        #saldos-iniciales h2, #forms-container h2, #historial-container h2, #transfer-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }

        #saldos-iniciales-inputs {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
        }

        .saldo-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .saldo-input-group label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }

        .saldo-input-group input[type="number"] {
            width: 100px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }

        #forms-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
        }

        .form-section {
            flex: 1;
            min-width: 300px; /* Ancho mínimo para cada formulario */
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            text-align: center;
            color: #444;
            margin-bottom: 15px;
        }

        .form-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section select {
            width: calc(100% - 20px); /* Ajusta el ancho para el padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Incluye padding en el ancho */
        }

        .form-section .radio-group, .form-section .select-group {
            margin-bottom: 15px;
        }

        .form-section .radio-group label, .form-section .select-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }

        .form-section button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        .form-section button:hover {
            background-color: #0056b3;
        }

        #historial-container {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        #historial-list {
            list-style: none;
            padding: 0;
        }

        #historial-list li {
            background-color: #fff;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan */
        }

        #historial-list li.ingreso {
            border-left: 5px solid #28a745; /* Verde para ingresos */
        }

        #historial-list li.gasto {
            border-left: 5px solid #dc3545; /* Rojo para gastos */
        }
        #historial-list li.transferencia {
            border-left: 5px solid #ffc107; /* Amarillo/naranja para transferencias */
        }


        #historial-list .item-info {
            flex-grow: 1;
            padding-right: 10px; /* Espacio entre info y monto */
        }

        #historial-list .item-monto {
            font-weight: bold;
            font-size: 1.1em;
        }

        #historial-list .item-monto.ingreso {
            color: #28a745;
        }

        #historial-list .item-monto.gasto {
            color: #dc3545;
        }
        #historial-list .item-monto.transferencia {
            color: #007bff; /* Azul para transferencias */
        }


        #botones-historial {
            text-align: center;
            margin-top: 20px;
        }

        #botones-historial button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        #reiniciar-historial-btn {
            background-color: #ffc107;
            color: #333;
        }

        #reiniciar-historial-btn:hover {
            background-color: #e0a800;
        }

        #exportar-historial-btn {
            background-color: #17a2b8;
            color: white;
        }

        #exportar-historial-btn:hover {
            background-color: #138496;
        }

        @media (max-width: 768px) {
            #billetera-container {
                width: 95%;
                padding: 15px;
            }

            #resumen-saldos, #saldos-iniciales-inputs, #forms-container, #transfer-container .form-section {
                flex-direction: column;
                align-items: center;
            }

            /* En móviles, los bloques ocuparán todo el ancho disponible */
            .saldo-block, .form-section {
                width: 100%;
                min-width: unset; /* Quitar el min-width para móviles */
                max-width: 100%; /* Permitir que ocupen el ancho completo */
                flex-basis: auto; /* Resetear flex-basis */
            }

            .saldo-input-group input[type="number"] {
                width: calc(100% - 20px);
            }
             #current-month-year { /* Ajuste para móviles */
                position: static; /* No flotar en móviles */
                margin-bottom: 10px; /* Añadir espacio abajo */
                text-align: center;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="billetera-container">
        <h1>Mi Billetera Virtual</h1>

        <div id="current-month-year"></div>

        <div id="container-saldos-principales">
            <div id="resumen-saldos">
                <div class="saldo-block">
                    <p>Total Disponible</p>
                    <span id="saldo-total">$0.00</span>
                </div>
                <div class="saldo-block">
                    <p>Saldo en Banco</p>
                    <span id="saldo-cuenta">$0.00</span>
                </div>
                <div class="saldo-block">
                    <p>Saldo en Casa</p>
                    <span id="saldo-mano">$0.00</span>
                </div>
                <div class="saldo-block">
                    <p>Saldo Billetera</p>
                    <span id="saldo-billetera">$0.00</span>
                </div>
                 <div class="saldo-block">
                    <p>Saldo Moto MP</p>
                    <span id="saldo-moto-mp">$0.00</span>
                </div>
                <div class="saldo-block">
                    <p>Total Ingresos</p>
                    <span id="total-ingresos-mes">$0.00</span>
                </div>
                <div class="saldo-block">
                    <p>Total Gastos</p>
                    <span id="total-gastos-mes">$0.00</span>
                </div>
            </div>
        </div>

        <div id="saldos-iniciales">
            <h2>Saldos Iniciales</h2>
            <div id="saldos-iniciales-inputs">
                <div class="saldo-input-group">
                    <label for="initial-cuenta">Banco:</label>
                    <input type="number" id="initial-cuenta" value="0" step="0.01">
                </div>
                <div class="saldo-input-group">
                    <label for="initial-mano">Casa:</label>
                    <input type="number" id="initial-mano" value="0" step="0.01">
                </div>
                <div class="saldo-input-group">
                    <label for="initial-billetera">Billetera:</label>
                    <input type="number" id="initial-billetera" value="0" step="0.01">
                </div>
                <div class="saldo-input-group">
                    <label for="initial-moto-mp">Moto MP:</label>
                    <input type="number" id="initial-moto-mp" value="0" step="0.01">
                </div>
            </div>
            <button id="set-initial-saldos">Establecer Saldos Iniciales</button>
        </div>

        <div id="forms-container">
            <div class="form-section">
                <h3>Nuevo Ingreso</h3>
                <form id="form-ingreso">
                    <label for="descripcion-ingreso">Descripción:</label>
                    <input type="text" id="descripcion-ingreso" required>

                    <label for="monto-ingreso">Monto:</label>
                    <input type="number" id="monto-ingreso" min="0.01" step="0.01" required>

                    <label for="categoria-ingreso">Categoría:</label>
                    <select id="categoria-ingreso" required>
                        <option value="">Seleccione una categoría</option>
                        <option value="viajes">Viajes</option>
                        <option value="sistemas">Sistemas</option>
                        <option value="prestamo tc">Prestamo Tc</option>
                        <option value="ahorro">Ahorro</option>
                        <option value="intereses">Intereses</option>
                        <option value="otros">Otros</option>

                    </select>

                    <label>Fuente de Ingreso:</label>
                    <div class="radio-group">
                        <input type="radio" id="ingreso-banco" name="fuente-ingreso" value="banco" checked>
                        <label for="ingreso-banco">Banco</label>
                        <input type="radio" id="ingreso-casa" name="fuente-ingreso" value="casa">
                        <label for="ingreso-casa">Casa</label>
                        <input type="radio" id="ingreso-billetera" name="fuente-ingreso" value="billetera">
                        <label for="ingreso-billetera">Billetera</label>
                        <input type="radio" id="ingreso-mp" name="fuente-ingreso" value="motoMP">
                        <label for="ingreso-mp">MP</label>
                    </div>

                    <button type="submit">Agregar Ingreso</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Nuevo Gasto</h3>
                <form id="form-gasto">
                    <label for="descripcion-gasto">Descripción:</label>
                    <input type="text" id="descripcion-gasto" required>

                    <label for="monto-gasto">Monto:</label>
                    <input type="number" id="monto-gasto" min="0.01" step="0.01" required>

                    <label for="categoria-gasto">Categoría:</label>
                    <select id="categoria-gasto" required>
                        <option value="">Seleccione una categoría</option>
                        <option value="comida">Comida</option>
                        <option value="nafta">Nafta</option>
                        <option value="Joda">Joda</option>
                        <option value="expensas">Expensas</option>
                        <option value="ropa">Ropa</option>
                        <option value="adelanto">Adelanto</option>
                        <option value="pago tc">Pago tc</option>
                        <option value="otros">Otros</option>
                    </select>

                    <label>Fuente de Gasto:</label>
                    <div class="radio-group">
                        <input type="radio" id="gasto-banco" name="fuente-gasto" value="banco" checked>
                        <label for="gasto-banco">Banco</label>
                        <input type="radio" id="gasto-casa" name="fuente-gasto" value="casa">
                        <label for="gasto-casa">Casa</label>
                        <input type="radio" id="gasto-billetera" name="fuente-gasto" value="billetera">
                        <label for="gasto-billetera">Billetera</label>
                        <input type="radio" id="gasto-mp" name="fuente-gasto" value="motoMP">
                        <label for="gasto-mp">MP</label>
                    </div>

                    <button type="submit">Agregar Gasto</button>
                </form>
            </div>
        </div>

        <div id="transfer-container" class="form-section">
            <h2>Mover Plata entre Cuentas</h2>
            <form id="form-transferencia">
                <label for="monto-transferencia">Monto:</label>
                <input type="number" id="monto-transferencia" min="0.01" step="0.01" required>

                <label for="origen-transferencia">De:</label>
                <select id="origen-transferencia" required>
                    <option value="">Seleccione origen</option>
                    <option value="banco">Banco</option>
                    <option value="casa">Casa</option>
                    <option value="billetera">Billetera</option>
                </select>

                <label for="destino-transferencia">A:</label>
                <select id="destino-transferencia" required>
                    <option value="">Seleccione destino</option>
                    <option value="banco">Banco</option>
                    <option value="casa">Casa</option>
                    <option value="billetera">Billetera</option>
                    <option value="motoMP">Moto MP</option>
                </select>

                <button type="submit">Realizar Transferencia</button>
            </form>
        </div>


        <div id="historial-container">
            <h2>Historial de Movimientos</h2>
            <ul id="historial-list">
                </ul>
            <div id="botones-historial">
                <button id="reiniciar-historial-btn">Reiniciar Historial y Saldos Mensuales</button>
                <button id="exportar-historial-btn">Exportar Historial a CSV</button>
            </div>
        </div>
    </div>

    <script>
        // Variables para los saldos actuales
        let saldoCuentaActual = 0;
        let saldoManoActual = 0;
        let saldoBilleteraActual = 0;
        let saldoMotoMPActual = 0;

        let saldoCuentaInicialInput = 0;
        let saldoManoInicialInput = 0;
        let saldoBilleteraInicialInput = 0;
        let saldoMotoMPInicialInput = 0;


        // Obtener elementos del DOM
        const saldoTotalSpan = document.getElementById('saldo-total');
        const saldoCuentaSpan = document.getElementById('saldo-cuenta');
        const saldoManoSpan = document.getElementById('saldo-mano');
        const saldoBilleteraSpan = document.getElementById('saldo-billetera');
        const saldoMotoMPSpan = document.getElementById('saldo-moto-mp');
        // NUEVO: Spans para totales de ingresos y gastos del mes
        const totalIngresosMesSpan = document.getElementById('total-ingresos-mes');
        const totalGastosMesSpan = document.getElementById('total-gastos-mes');


        const initialCuentaInput = document.getElementById('initial-cuenta');
        const initialManoInput = document.getElementById('initial-mano');
        const initialBilleteraInput = document.getElementById('initial-billetera');
        const initialMotoMPInput = document.getElementById('initial-moto-mp');

        const setInitialSaldosBtn = document.getElementById('set-initial-saldos');

        const formularioIngreso = document.getElementById('form-ingreso');
        const formularioGasto = document.getElementById('form-gasto');
        const formularioTransferencia = document.getElementById('form-transferencia');

        const historialList = document.getElementById('historial-list');
        const reiniciarHistorialButton = document.getElementById('reiniciar-historial-btn');
        const exportarHistorialButton = document.getElementById('exportar-historial-btn');

        const currentMonthYearDiv = document.getElementById('current-month-year');

        let historialIngresos = [];
        let historialGastos = [];
        let historialTransferencias = [];

        // --- Funciones de Carga y Guardado ---

        function cargarSaldosLocalStorage() {
            const savedCuentaActual = localStorage.getItem('saldoCuentaActual');
            const savedManoActual = localStorage.getItem('saldoManoActual');
            const savedBilleteraActual = localStorage.getItem('saldoBilleteraActual');
            const savedMotoMPActual = localStorage.getItem('saldoMotoMPActual');

            if (savedCuentaActual !== null) saldoCuentaActual = parseFloat(savedCuentaActual);
            if (savedManoActual !== null) saldoManoActual = parseFloat(savedManoActual);
            if (savedBilleteraActual !== null) saldoBilleteraActual = parseFloat(savedBilleteraActual);
            if (savedMotoMPActual !== null) saldoMotoMPActual = parseFloat(savedMotoMPActual);

            const savedCuentaInicialInput = localStorage.getItem('saldoCuentaInicialInput');
            const savedManoInicialInput = localStorage.getItem('saldoManoInicialInput');
            const savedBilleteraInicialInput = localStorage.getItem('saldoBilleteraInicialInput');
            const savedMotoMPInicialInput = localStorage.getItem('saldoMotoMPInicialInput');

            if (savedCuentaInicialInput !== null) {
                saldoCuentaInicialInput = parseFloat(savedCuentaInicialInput);
                initialCuentaInput.value = saldoCuentaInicialInput.toFixed(2);
            } else {
                 initialCuentaInput.value = saldoCuentaActual.toFixed(2);
                 saldoCuentaInicialInput = saldoCuentaActual;
            }
            if (savedManoInicialInput !== null) {
                saldoManoInicialInput = parseFloat(savedManoInicialInput);
                initialManoInput.value = saldoManoInicialInput.toFixed(2);
            } else {
                initialManoInput.value = saldoManoActual.toFixed(2);
                saldoManoInicialInput = saldoManoActual;
            }
            if (savedBilleteraInicialInput !== null) {
                saldoBilleteraInicialInput = parseFloat(savedBilleteraInicialInput);
                initialBilleteraInput.value = saldoBilleteraInicialInput.toFixed(2);
            } else {
                initialBilleteraInput.value = saldoBilleteraActual.toFixed(2);
                saldoBilleteraInicialInput = saldoBilleteraActual;
            }
            if (savedMotoMPInicialInput !== null) {
                saldoMotoMPInicialInput = parseFloat(savedMotoMPInicialInput);
                initialMotoMPInput.value = saldoMotoMPInicialInput.toFixed(2);
            } else {
                initialMotoMPInput.value = saldoMotoMPActual.toFixed(2);
                saldoMotoMPInicialInput = saldoMotoMPActual;
            }
        }

        function guardarSaldosLocalStorage() {
            localStorage.setItem('saldoCuentaActual', saldoCuentaActual.toFixed(2));
            localStorage.setItem('saldoManoActual', saldoManoActual.toFixed(2));
            localStorage.setItem('saldoBilleteraActual', saldoBilleteraActual.toFixed(2));
            localStorage.setItem('saldoMotoMPActual', saldoMotoMPActual.toFixed(2));

            localStorage.setItem('saldoCuentaInicialInput', saldoCuentaInicialInput.toFixed(2));
            localStorage.setItem('saldoManoInicialInput', saldoManoInicialInput.toFixed(2));
            localStorage.setItem('saldoBilleteraInicialInput', saldoBilleteraInicialInput.toFixed(2));
            localStorage.setItem('saldoMotoMPInicialInput', saldoMotoMPInicialInput.toFixed(2));
        }

        function cargarHistorialLocalStorage() {
            const savedIngresos = localStorage.getItem('historialIngresos');
            const savedGastos = localStorage.getItem('historialGastos');
            const savedTransferencias = localStorage.getItem('historialTransferencias');

            if (savedIngresos) historialIngresos = JSON.parse(savedIngresos);
            if (savedGastos) historialGastos = JSON.parse(savedGastos);
            if (savedTransferencias) historialTransferencias = JSON.parse(savedTransferencias);
        }

        function guardarHistorialLocalStorage() {
            localStorage.setItem('historialIngresos', JSON.stringify(historialIngresos));
            localStorage.setItem('historialGastos', JSON.stringify(historialGastos));
            localStorage.setItem('historialTransferencias', JSON.stringify(historialTransferencias));
        }

        // --- Funciones de Actualización de UI ---

        function actualizarSaldosVisual() {
            const saldoTotal = saldoCuentaActual + saldoManoActual + saldoBilleteraActual;
            saldoTotalSpan.textContent = `$${saldoTotal.toFixed(2)}`;
            saldoCuentaSpan.textContent = `$${saldoCuentaActual.toFixed(2)}`;
            saldoManoSpan.textContent = `$${saldoManoActual.toFixed(2)}`;
            saldoBilleteraSpan.textContent = `$${saldoBilleteraActual.toFixed(2)}`;
            saldoMotoMPSpan.textContent = `$${saldoMotoMPActual.toFixed(2)}`;
        }

        // NUEVO: Función para actualizar totales de ingresos y gastos del mes
        function actualizarTotalesMes() {
            let ingresosDelMes = 0;
            let gastosDelMes = 0;
            const ahora = new Date();
            const mesActual = ahora.getMonth(); // 0 (Enero) a 11 (Diciembre)
            const anioActual = ahora.getFullYear();

            historialIngresos.forEach(ingreso => {
                const fechaIngreso = new Date(ingreso.fecha + "T00:00:00"); // Asegurar que se interprete como local
                if (fechaIngreso.getMonth() === mesActual && fechaIngreso.getFullYear() === anioActual) {
                    ingresosDelMes += ingreso.monto;
                }
            });

            historialGastos.forEach(gasto => {
                const fechaGasto = new Date(gasto.fecha + "T00:00:00"); // Asegurar que se interprete como local
                if (fechaGasto.getMonth() === mesActual && fechaGasto.getFullYear() === anioActual) {
                    gastosDelMes += gasto.monto;
                }
            });

            totalIngresosMesSpan.textContent = `$${ingresosDelMes.toFixed(2)}`;
            totalGastosMesSpan.textContent = `$${gastosDelMes.toFixed(2)}`;
        }


        function mostrarHistorialMovimientos() {
            historialList.innerHTML = '';

            const todosLosMovimientos = [
                ...historialIngresos.map(m => ({ ...m, tipo: 'ingreso' })),
                ...historialGastos.map(m => ({ ...m, tipo: 'gasto' })),
                ...historialTransferencias.map(m => ({ ...m, tipo: 'transferencia' }))
            ].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            todosLosMovimientos.forEach(movimiento => {
                const li = document.createElement('li');
                li.classList.add(movimiento.tipo);

                // movimiento.fecha está en formato YYYY-MM-DD
                // Para evitar problemas de zona horaria al convertir a Date, podemos añadir la hora
                const fechaMovimiento = new Date(movimiento.fecha + "T00:00:00");
                const fechaFormateada = fechaMovimiento.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });

                const getFuenteDisplay = (fuente) => {
                    if (fuente === 'banco') return 'Banco';
                    if (fuente === 'casa') return 'Casa';
                    if (fuente === 'billetera') return 'Billetera';
                    if (fuente === 'motoMP') return 'Moto MP';
                    return fuente;
                };

                let itemInfoHTML = '';
                let itemMontoHTML = '';

                if (movimiento.tipo === 'ingreso' || movimiento.tipo === 'gasto') {
                    itemInfoHTML = `
                        <strong>${movimiento.descripcion}</strong> (${movimiento.categoria}) <br>
                        <small>Fuente: ${getFuenteDisplay(movimiento.fuente)} - Fecha: ${fechaFormateada}</small>
                    `;
                    itemMontoHTML = `
                        ${movimiento.tipo === 'ingreso' ? '+' : '-'}$${movimiento.monto.toFixed(2)}
                    `;
                } else if (movimiento.tipo === 'transferencia') {
                    itemInfoHTML = `
                        <strong>Transferencia</strong> <br>
                        <small>De: ${getFuenteDisplay(movimiento.origen)} a ${getFuenteDisplay(movimiento.destino)} - Fecha: ${fechaFormateada}</small>
                    `;
                    itemMontoHTML = `$${movimiento.monto.toFixed(2)}`;
                }


                li.innerHTML = `
                    <div class="item-info">
                        ${itemInfoHTML}
                    </div>
                    <span class="item-monto ${movimiento.tipo}">
                        ${itemMontoHTML}
                    </span>
                `;
                historialList.appendChild(li);
            });
        }

        function displayCurrentMonthYear() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long' };
            const monthYearString = now.toLocaleDateString('es-ES', options);
            currentMonthYearDiv.textContent = monthYearString.charAt(0).toUpperCase() + monthYearString.slice(1);
        }

        // --- Lógica de la Aplicación ---

        function setInitialSaldos() {
            saldoCuentaInicialInput = parseFloat(initialCuentaInput.value) || 0;
            saldoManoInicialInput = parseFloat(initialManoInput.value) || 0;
            saldoBilleteraInicialInput = parseFloat(initialBilleteraInput.value) || 0;
            saldoMotoMPInicialInput = parseFloat(initialMotoMPInput.value) || 0;

            saldoCuentaActual = saldoCuentaInicialInput;
            saldoManoActual = saldoManoInicialInput;
            saldoBilleteraActual = saldoBilleteraInicialInput;
            saldoMotoMPActual = saldoMotoMPInicialInput;

            actualizarSaldosVisual();
            guardarSaldosLocalStorage();
            alert('Saldos iniciales establecidos/actualizados.');
        }

        function reiniciarHistorialCompleto() {
            if (confirm('¿Estás seguro de que quieres reiniciar el historial de movimientos y los saldos de Banco y Casa a CERO? (Billetera y Moto MP mantendrán su saldo actual.)')) {
                historialIngresos = [];
                historialGastos = [];
                historialTransferencias = [];
                guardarHistorialLocalStorage();

                saldoCuentaActual = 0;
                saldoManoActual = 0;

                initialCuentaInput.value = "0.00";
                initialManoInput.value = "0.00";
                saldoCuentaInicialInput = 0;
                saldoManoInicialInput = 0;

                // Billetera y Moto MP no se reinician aquí, mantienen su saldo actual.
                // Sus inputs iniciales también reflejan el último valor establecido o el actual si no se han tocado.
                // Para que los inputs iniciales de billetera y motoMP se mantengan, no los modificamos aquí.

                guardarSaldosLocalStorage(); // Guarda los saldos actuales (incluyendo Banco y Casa en 0)
                                            // y los valores de los inputs iniciales (incluyendo Banco y Casa en 0)
                actualizarSaldosVisual();
                mostrarHistorialMovimientos();
                actualizarTotalesMes(); // NUEVO: Actualizar totales del mes
                alert('Historial reiniciado. Saldos de Banco y Casa puestos a cero. Billetera y Moto MP mantienen su saldo.');
            }
        }

        function exportarHistorialCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tipo,Descripcion/Origen,Monto,Categoria/Destino,Fuente/Origen Transf,Fecha\n";

            const todosLosMovimientos = [
                ...historialIngresos.map(m => ({ tipo: 'Ingreso', descripcion: m.descripcion, monto: m.monto, categoria_destino: m.categoria, fuente_origen: m.fuente, fecha: m.fecha })),
                ...historialGastos.map(m => ({ tipo: 'Gasto', descripcion: m.descripcion, monto: m.monto, categoria_destino: m.categoria, fuente_origen: m.fuente, fecha: m.fecha })),
                ...historialTransferencias.map(m => ({ tipo: 'Transferencia', descripcion: `De ${getFuenteDisplay(m.origen)} a ${getFuenteDisplay(m.destino)}`, monto: m.monto, categoria_destino: getFuenteDisplay(m.destino), fuente_origen: getFuenteDisplay(m.origen), fecha: m.fecha }))
            ].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            const getFuenteDisplay = (fuente) => { // Helper local para el CSV
                    if (fuente === 'banco') return 'Banco';
                    if (fuente === 'casa') return 'Casa';
                    if (fuente === 'billetera') return 'Billetera';
                    if (fuente === 'motoMP') return 'Moto MP';
                    return fuente;
            };

            todosLosMovimientos.forEach(mov => {
                 const fechaMovimiento = new Date(mov.fecha + "T00:00:00");
                 const fechaFormateadaCSV = fechaMovimiento.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                const fila = [
                    mov.tipo,
                    `"${mov.descripcion.replace(/"/g, '""')}"`,
                    mov.monto.toFixed(2),
                    `"${mov.categoria_destino.replace(/"/g, '""')}"`,
                    `"${mov.fuente_origen.replace(/"/g, '""')}"`,
                    fechaFormateadaCSV
                ].join(",");
                csvContent += fila + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historial_billetera.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            cargarSaldosLocalStorage();
            cargarHistorialLocalStorage();
            actualizarSaldosVisual();
            mostrarHistorialMovimientos(); // CORREGIDO: Llamar para mostrar historial al cargar
            actualizarTotalesMes();       // NUEVO: Calcular y mostrar totales del mes al cargar
            displayCurrentMonthYear();
        });

        setInitialSaldosBtn.addEventListener('click', setInitialSaldos);

        formularioIngreso.addEventListener('submit', (e) => {
            e.preventDefault();

            const descripcionIngreso = document.getElementById('descripcion-ingreso').value;
            const montoIngreso = parseFloat(document.getElementById('monto-ingreso').value);
            const categoriaIngreso = document.getElementById('categoria-ingreso').value;
            const fuenteIngreso = document.querySelector('input[name="fuente-ingreso"]:checked').value;
            const fechaIngreso = new Date().toISOString().split('T')[0];

            if (montoIngreso <= 0) {
                alert('El monto del ingreso debe ser mayor a cero.');
                return;
            }

            if (fuenteIngreso === 'banco') {
                saldoCuentaActual += montoIngreso;
            } else if (fuenteIngreso === 'casa') {
                saldoManoActual += montoIngreso;
            } else if (fuenteIngreso === 'billetera') {
                saldoBilleteraActual += montoIngreso;
            } else if (fuenteIngreso === 'motoMP') {
                saldoMotoMPActual += montoIngreso;
            }

            actualizarSaldosVisual();
            guardarSaldosLocalStorage();

            const nuevoIngreso = { descripcion: descripcionIngreso, monto: montoIngreso, categoria: categoriaIngreso, fuente: fuenteIngreso, fecha: fechaIngreso };
            historialIngresos.push(nuevoIngreso);
            mostrarHistorialMovimientos();
            actualizarTotalesMes(); // NUEVO
            guardarHistorialLocalStorage();

            formularioIngreso.reset();
            document.getElementById('ingreso-banco').checked = true;
        });

        formularioGasto.addEventListener('submit', (e) => {
            e.preventDefault();

            const descripcionGasto = document.getElementById('descripcion-gasto').value;
            const montoGasto = parseFloat(document.getElementById('monto-gasto').value);
            const categoriaGasto = document.getElementById('categoria-gasto').value;
            const fuenteGasto = document.querySelector('input[name="fuente-gasto"]:checked').value;
            const fechaGasto = new Date().toISOString().split('T')[0];

            if (montoGasto <= 0) {
                alert('El monto del gasto debe ser mayor a cero.');
                return;
            }

            if (fuenteGasto === 'motoMP') {
                alert('No se puede registrar un gasto desde Moto MP. Esta es una cuenta de ahorro.');
                return;
            }

            let saldoSuficiente = true;
            if (fuenteGasto === 'banco' && montoGasto > saldoCuentaActual) {
                saldoSuficiente = false;
            } else if (fuenteGasto === 'casa' && montoGasto > saldoManoActual) {
                saldoSuficiente = false;
            } else if (fuenteGasto === 'billetera' && montoGasto > saldoBilleteraActual) {
                saldoSuficiente = false;
            }

            if (!saldoSuficiente) {
                alert('Saldo insuficiente en la fuente seleccionada.');
                return;
            }

            if (fuenteGasto === 'banco') {
                saldoCuentaActual -= montoGasto;
            } else if (fuenteGasto === 'casa') {
                saldoManoActual -= montoGasto;
            } else if (fuenteGasto === 'billetera') {
                saldoBilleteraActual -= montoGasto;
            }

            actualizarSaldosVisual();
            guardarSaldosLocalStorage();

            const nuevoGasto = { descripcion: descripcionGasto, monto: montoGasto, categoria: categoriaGasto, fuente: fuenteGasto, fecha: fechaGasto };
            historialGastos.push(nuevoGasto);
            mostrarHistorialMovimientos();
            actualizarTotalesMes(); // NUEVO
            guardarHistorialLocalStorage();

            formularioGasto.reset();
            document.getElementById('gasto-banco').checked = true;
        });

        formularioTransferencia.addEventListener('submit', (e) => {
            e.preventDefault();

            const montoTransferencia = parseFloat(document.getElementById('monto-transferencia').value);
            const origenTransferencia = document.getElementById('origen-transferencia').value;
            const destinoTransferencia = document.getElementById('destino-transferencia').value;
            const fechaTransferencia = new Date().toISOString().split('T')[0];

            if (montoTransferencia <= 0) {
                alert('El monto de la transferencia debe ser mayor a cero.');
                return;
            }

            if (origenTransferencia === '' || destinoTransferencia === '') {
                alert('Por favor, seleccione las cuentas de origen y destino.');
                return;
            }
            if (origenTransferencia === destinoTransferencia) {
                alert('La cuenta de origen y destino no pueden ser la misma.');
                return;
            }

            if (origenTransferencia === 'motoMP') {
                alert('No se puede transferir dinero DESDE Moto MP. Esta es una cuenta de ahorro.');
                return;
            }

            let saldoOrigenActual;
            switch (origenTransferencia) {
                case 'banco': saldoOrigenActual = saldoCuentaActual; break;
                case 'casa': saldoOrigenActual = saldoManoActual; break;
                case 'billetera': saldoOrigenActual = saldoBilleteraActual; break;
            }

            if (montoTransferencia > saldoOrigenActual) {
                alert('Saldo insuficiente en la cuenta de origen para realizar la transferencia.');
                return;
            }

            switch (origenTransferencia) {
                case 'banco': saldoCuentaActual -= montoTransferencia; break;
                case 'casa': saldoManoActual -= montoTransferencia; break;
                case 'billetera': saldoBilleteraActual -= montoTransferencia; break;
            }

            switch (destinoTransferencia) {
                case 'banco': saldoCuentaActual += montoTransferencia; break;
                case 'casa': saldoManoActual += montoTransferencia; break;
                case 'billetera': saldoBilleteraActual += montoTransferencia; break;
                case 'motoMP': saldoMotoMPActual += montoTransferencia; break;
            }

            actualizarSaldosVisual();
            guardarSaldosLocalStorage();

            const nuevaTransferencia = {
                monto: montoTransferencia,
                origen: origenTransferencia,
                destino: destinoTransferencia,
                fecha: fechaTransferencia
            };
            historialTransferencias.push(nuevaTransferencia);
            mostrarHistorialMovimientos();
            // Las transferencias no afectan los totales de ingresos/gastos del mes, solo mueven dinero entre cuentas.
            guardarHistorialLocalStorage();

            formularioTransferencia.reset();
        });


        reiniciarHistorialButton.addEventListener('click', reiniciarHistorialCompleto);
        exportarHistorialButton.addEventListener('click', exportarHistorialCSV);

    </script>
</body>
</html>
